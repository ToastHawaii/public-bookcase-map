<!DOCTYPE html>
<html lang="de">
  <head>
    <title>Öffentliche Bücherschränke</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, target-densitydpi=device-dpi, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta
      name="description"
      content="Dies ist eine einfache Karte, welche öffentliche Bücherschränke in ihrer Nähe anzeigt."
    />

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/icons/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/icons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/icons/favicon-16x16.png"
    />
    <link rel="manifest" href="/icons/site.webmanifest" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#734a08" />
    <link rel="shortcut icon" href="/icons/favicon.ico" />
    <meta name="msapplication-TileColor" content="#ffc40d" />
    <meta name="msapplication-config" content="/icons/browserconfig.xml" />
    <meta name="theme-color" content="#ffffff" />

    <link rel="stylesheet" href="/lib/OverPassLayer.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
      integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
      integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
      crossorigin=""
    ></script>
    <script src="/lib/OverPassLayer.bundle.js"></script>
    <script src="/lib/md5.js"></script>
    <script src="/lib/simple-opening-hours.js"></script>
    <style>
      body {
        padding: 0;
        margin: 0;
      }

      html,
      body,
      #map {
        height: 100%;
        width: 100%;
      }
    </style>

    <link
      href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/style.css" media="screen" type="text/css" />
  </head>

  <body>
    <div id="map"></div>
    <script>
      var days = ["su", "mo", "tu", "we", "th", "fr", "sa"];

      var attr_side =
        '<a href="https://public-bookcase.github.io/de">Über diese Seite</a>';
      var attr_osm =
        'Map data &copy; <a href="https://openstreetmap.org/">OpenStreetMap</a> contributors';
      var attr_overpass =
        'POI via <a href="https://www.overpass-api.de/">Overpass API</a>';

      var osm = new L.TileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          opacity: 0.7,
          attribution: [attr_side, attr_osm, attr_overpass].join(" | ")
        }
      );

      var map = new L.Map("map").addLayer(osm).setView(new L.LatLng(47, 8), 10);

      var opl = new L.OverPassLayer({
        markerIcon: L.icon({
          iconUrl:
            "https://wiki.openstreetmap.org/w/images/b/b2/Public_bookcase-14.svg",
          iconSize: [28, 28]
        }),
        minZoomIndicatorEnabled: false,
        minZoom: 10,
        query: '(node["amenity"="public_bookcase"]({{bbox}}););out qt;',
        onSuccess(data) {
          for (let i = 0; i < data.elements.length; i++) {
            let pos;
            let marker;
            const e = data.elements[i];

            if (e.id in this._ids) {
              continue;
            }

            this._ids[e.id] = true;

            if (e.type === "node") {
              pos = L.latLng(e.lat, e.lon);
            } else {
              pos = L.latLng(e.center.lat, e.center.lon);
            }

            if (this.options.markerIcon) {
              marker = L.marker(pos, { icon: this.options.markerIcon });
            } else {
              marker = L.circle(pos, 20, {
                stroke: false,
                fillColor: "#E54041",
                fillOpacity: 0.9
              });
            }

            let model = {
              address: {
                name: e.tags.name || e.tags.operator || e.tags.brand || "",
                postcode: e.tags["addr:postcode"] || "",
                locality: e.tags["addr:city"] || "",
                street: e.tags["addr:street"] || "",
                houseNumber: e.tags["addr:housenumber"] || "",
                houseName: "",
                latitude: e.lat,
                longitude: e.lon
              },
              hasOpeningHours: !!e.tags.opening_hours,
              opening: new SimpleOpeningHours(e.tags.opening_hours || ""),
              img: "",
              imgExtern: false,

              wheelchair: false,
              light: false,
              indoor: false,

              website: "",
              email: "",
              phone: ""
            };

            if (!model.img && e.tags.mapillary)
              model.img = `https://d1cuyjsrcm0gby.cloudfront.net/${
                e.tags.mapillary
              }/thumb-320.jpg`;

            model.img =
              model.img ||
              toWikimediaCommensUrl(e.tags.image) ||
              toWikimediaCommensUrl(e.tags.wikimedia_commons) ||
              e.tags.flickr ||
              e.tags.image ||
              e.tags.wikimedia_commons ||
              e.tags.picture;

            model.wheelchair = e.tags.wheelchair === "yes";
            model.light = e.tags.lit === "yes";
            model.indoor =
              e.tags.location === "indoor" || e.tags.indoor === "yes";
            model.website =
              model.website ||
              e.tags.website ||
              (e.tags.wikipedia
                ? `https://wikipedia.org/wiki/${e.tags.wikipedia}`
                : ``) ||
              e.tags.url ||
              e.tags["contact:website"];
            model.email =
              model.email || e.tags.email || e.tags["contact:email"];
            model.phone =
              model.phone || e.tags.phone || e.tags["contact:phone"];

            let loaded = false;
            const popup = L.popup({
              minWidth: 200,
              autoPanPaddingTopLeft: [10, 85],
              autoPanPaddingBottomRight: [10, 10]
            }).setContent(function() {
              if (!loaded) {
                loaded = true;

                let request = new XMLHttpRequest();

                request.onreadystatechange = function() {
                  if (request.readyState !== 4) return;
                  if (request.status !== 200) return;

                  let result = JSON.parse(request.responseText);

                  model.address.name =
                    model.address.name ||
                    result.namedetails.name ||
                    result.namedetails.official_name ||
                    "";
                  model.address.postcode =
                    model.address.postcode || result.address.postcode || "";
                  model.address.locality =
                    model.address.locality ||
                    result.address.city ||
                    result.address.town ||
                    result.address.village ||
                    result.address.suburb ||
                    result.address.neighbourhood ||
                    result.address.state ||
                    result.address.county ||
                    "";
                  model.address.street =
                    model.address.street ||
                    result.address.path ||
                    result.address.footway ||
                    result.address.road ||
                    result.address.cycleway ||
                    result.address.pedestrian ||
                    result.address.farmyard ||
                    result.address.construction ||
                    result.namedetails.name ||
                    result.namedetails.official_name ||
                    result.address.neighbourhood ||
                    "";
                  model.address.houseNumber =
                    model.address.houseNumber ||
                    result.address.house_number ||
                    "";
                  model.address.houseName =
                    model.address.houseName ||
                    result.namedetails.name ||
                    result.namedetails.official_name ||
                    "";

                  popup.update();
                };

                request.open(
                  "Get",
                  "https://nominatim.openstreetmap.org/reverse?format=json&addressdetails=1&namedetails=1&lat=" +
                    e.lat +
                    "&lon=" +
                    e.lon
                );

                request.send();
              }

              const el = document.createElement("div");
              el.innerHTML = `<div id="hcard-Name" class="vcard">
                        ${
                          model.address.name
                            ? `<strong class="fn">${
                                model.address.name
                              }</strong>`
                            : ""
                        }
                        <div class="adr">
                        
                        ${
                          model.indoor
                            ? `<i style="float:right;margin-left:5px;" class="fa fa-building-o"></i>`
                            : ``
                        }
                        
                        ${
                          model.light
                            ? `<i style="float:right;margin-left:5px;" class="fa fa-lightbulb-o"></i>`
                            : ``
                        }

                        ${
                          model.wheelchair
                            ? `<i style="float:right;margin-left:5px;" class="fa fa-wheelchair"></i>`
                            : ``
                        }
                        
                         <div class="street-address">${model.address.street} ${
                model.address.houseNumber
              }</div>
                            <span class="postal-code">${
                              model.address.postcode
                            }</span>
                         <span class="region">${model.address.locality}</span>
                        </div>
                     ${
                       model.hasOpeningHours
                         ? `<br><div>${
                             model.opening.isOpenNow()
                               ? `Jetzt geöffnet`
                               : `Geschlossen`
                           } ${model.opening
                             .getTable()
                             [days[new Date().getDay()]].join(`, `)}</div>`
                         : ``
                     }  <br>
                        <div class="geo">
                         <small>
                         <a href="https://maps.apple.com/?ll=${
                           model.address.latitude
                         },${model.address.longitude}&q=${model.address.name}">
                           Routen
                         </a>
                         </small>
                        </div>
                        ${
                          model.img
                            ? !model.imgExtern
                              ? `<br /><img style="max-width:300px;max-height:300px;" src="${
                                  model.img
                                }"/>`
                              : `<br /><a href="${
                                  model.img
                                }" target="_blank"><i class="fa fa-photo fa-2x"></i></a>`
                            : ``
                        }
                        ${
                          model.website || model.email || model.phone
                            ? `
                        <div>
                          <br />
                          ${
                            model.website
                              ? `<a href="${
                                  model.website
                                }" target="_blank"><i class="fa fa-globe fa-lg"></i></a>&ensp;`
                              : ``
                          } 
                          ${
                            model.email
                              ? `<a href="mailto:${
                                  model.email
                                }" target="_blank"><i class="fa fa-envelope fa-lg"></i></a>&ensp;`
                              : ``
                          } 
                          ${
                            model.phone
                              ? `<a href="tel:${
                                  model.phone
                                }" target="_blank"><i class="fa fa-phone fa-lg"></i></a>&ensp;`
                              : ``
                          }
                       </div>`
                            : ``
                        }</div>`;

              return el;
            });

            if (model.img) {
              const imageElement = new Image();
              imageElement.onload = function() {
                setTimeout(function() {
                  popup.update();
                }, 1);
              };
              imageElement.onerror = function() {
                model.imgExtern = true;
                setTimeout(function() {
                  popup.update();
                }, 1);
              };
              imageElement.src = model.img;
            }

            marker.bindPopup(popup);
            this._markers.addLayer(marker);
          }
        }
      });

      // placeholders for the L.marker and L.circle representing user's current position and accuracy
      var current_position, current_accuracy;

      function onLocationFound(e) {
        // if position defined, then remove the existing position marker and accuracy circle from the map
        if (current_position) {
          map.removeLayer(current_position);
          map.removeLayer(current_accuracy);
        }

        var radius = e.accuracy / 2;

        current_position = L.marker(e.latlng).addTo(map);

        current_accuracy = L.circle(e.latlng, radius).addTo(map);

        map.locate({ watch: false, maxZoom: 16 });

        map.addLayer(opl);
      }

      function onLocationError(e) {
        map.addLayer(opl);
      }

      map.on("locationfound", onLocationFound);
      map.on("locationerror", onLocationError);

      map.locate({ setView: true, maxZoom: 16 });

      function locate() {
        map.stopLocate();
        map.locate({ setView: true, maxZoom: 16 });

        return false;
      }

      function search() {
        let request = new XMLHttpRequest();

        request.onreadystatechange = function() {
          if (request.readyState === 4) {
            if (request.status === 200) {
              let result = JSON.parse(request.responseText)[0];
              if (!result) return;

              map.flyToBounds([
                [result.boundingbox[0], result.boundingbox[2]],
                [result.boundingbox[1], result.boundingbox[3]]
              ]);
            }
          }
        };

        request.open(
          "Get",
          `https://nominatim.openstreetmap.org/search?format=json&q=${
            document.getElementById("osm-search").value
          }&limit=1`
        );

        request.send();

        return false;
      }

      function toWikimediaCommensUrl(source) {
        if (!source) return "";

        let fileName = "";

        if (source.toUpperCase().startsWith("File:".toUpperCase()))
          fileName = source.substring(5, source.length);

        if (!fileName) return "";

        const hash = md5(fileName);
        return `https://upload.wikimedia.org/wikipedia/commons/thumb/${hash.substring(
          0,
          1
        )}/${hash.substring(0, 2)}/${fileName}/320px-${fileName}`;
      }
    </script>
    <h1>
      Öffentliche Bücherschränke
    </h1>
    <div class="box">
      <div class="container">
        <form onsubmit="return search();">
          <button class="geo" type="button" onclick="return locate();">
            <i class="fa fa-dot-circle-o"></i>
          </button>
          <input type="search" id="osm-search" placeholder="Suche" />
          <button class="icon" type="submit">
            <i class="fa fa-search"></i>
          </button>
        </form>
      </div>
    </div>
  </body>
</html>
